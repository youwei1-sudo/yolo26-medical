# YOLO26 vs YOLOv9 对比分析报告

**版本**: 1.0
**日期**: 2025-01-29
**状态**: 最终报告

---

## 执行摘要

本报告对比分析了 YOLO26s 与 YOLOv9 v12.1 在 ImgAssist OCT 癌症检测任务上的性能表现。

### 核心结论

| 维度 | 优势模型 | 说明 |
|------|----------|------|
| Box-level mAP | **YOLOv9** | 76.6% vs 67.6% (+9.0%) |
| Patch-level Sensitivity | **YOLO26** | 98.82% vs 98.16% (+0.66%) |
| Patch-level Specificity | **YOLO26** | 8.34% vs 0.83% (+7.51%) |
| Val-Test 稳定性 | **YOLOv9** | Gap 更小，泛化更好 |

**当前推荐**: 继续使用 YOLOv9，暂缓 YOLO26 模型决策。

---

## 1. 模型配置对比

| 配置项 | YOLOv9 v12.1 | YOLO26s |
|--------|--------------|---------|
| **架构** | GELAN | C3k2 + C2PSA |
| **参数量** | ~9.6M | ~10M |
| **输入尺寸** | 320x672 | 672 (rect=True) |
| **预处理** | Rectangle letterbox (unstretch) | Y-axis squash to 320 |
| **优化器** | SGD | SGD |
| **NMS** | 后处理 NMS | Native end-to-end (NMS-free) |
| **量化兼容** | 一般 | INT8 友好 |

### 1.1 NMS vs NMS-free 说明

**NMS (Non-Maximum Suppression)** 是目标检测中用于过滤重叠检测框的后处理步骤。

#### YOLOv9 - 后处理 NMS

```
模型输出 → 大量候选框 (几千个) → NMS 后处理 → 最终检测框
                                    ↑
                              需要设置超参数:
                              - iou_thres (重叠多少算重复)
                              - max_det (每张图最多保留几个框)
```

**特点**：
- 需要额外计算步骤
- 有超参数需要调优
- 延迟不确定（候选框越多 NMS 越慢）

#### YOLO26 - NMS-free (端到端)

```
模型输出 → 直接就是最终检测框 (无需后处理)
              ↑
        模型内部已学会抑制重复框
```

**优势**：
- 不需要设置 `max_det`、`iou_thres` 等超参数
- 推理延迟确定、稳定
- 部署更简单（ONNX/TensorRT 导出更干净）
- INT8 量化更友好

#### 对比总结

| 方面 | YOLOv9 (后处理 NMS) | YOLO26 (NMS-free) |
|------|---------------------|-------------------|
| **输出** | 原始候选框 → 需筛选 | 直接最终框 |
| **后处理** | 需要 NMS 步骤 | 不需要 |
| **超参数** | 需要调 `max_det`, `iou_thres` | 无需设置 |
| **延迟** | 不确定（依赖框数量） | 确定、稳定 |
| **部署** | 需要 NMS 插件 | 直接导出 |

---

## 2. 评估模式说明

本报告使用两种评估模式，分别针对不同的临床需求：

### 2.1 Box-Level (框级) - 标准目标检测

**定义**: 每个检测框与 Ground Truth 框的 IoU 匹配

**计算指标**:
| 指标 | 公式 | 说明 |
|------|------|------|
| mAP@0.5 | - | IoU=0.5 时的平均精度 |
| mAP@0.5:0.95 | - | IoU 从 0.5 到 0.95 的平均 |
| Precision | TP / (TP + FP) | 检测框准确率 |
| Recall | TP / (TP + FN) | 检测框召回率 |

**使用场景**: 标准检测任务，评估 bounding box 定位精度

**conf 阈值**: 0.25 (标准)

### 2.2 Patch-Level (补丁级/图像级) - 医学影像专用

**定义**: 每张图像作为一个样本，判断是否有任何检测

**核心逻辑**:
```
对于每张图像:
  has_gt = 图像有无 GT 框 (是否有癌症)
  has_pred = 图像有无预测框 (conf >= threshold)

  if has_gt and has_pred:      TP  # 有癌症，检测到了
  elif not has_gt and not has_pred: TN  # 无癌症，没误报
  elif not has_gt and has_pred:     FP  # 无癌症，但误报了
  else:                             FN  # 有癌症，但漏诊了！
```

**计算指标**:
| 指标 | 公式 | 意义 |
|------|------|------|
| **Sensitivity** | TP / (TP + FN) | 不漏诊率 (**最重要!**) |
| Specificity | TN / (TN + FP) | 不误报率 |
| Precision | TP / (TP + FP) | 阳性预测准确率 |
| F2 Score | 5PR / (4P + R) | 召回率权重 4 倍 |

**使用场景**: 医学影像筛查，直接回答"这张图有没有可疑区域？"

**conf 阈值**: 0.001 (极低，确保高敏感度)

### 2.3 两种模式对比

| 方面 | Box-Level | Patch-Level |
|------|-----------|-------------|
| **评估单位** | 每个检测框 | 每张图像 |
| **conf 阈值** | 0.25 (标准) | 0.001 (高敏感) |
| **主要指标** | mAP@0.5 | Sensitivity |
| **临床意义** | 定位准确性 | 不漏诊率 |
| **适用场景** | 精确定位 | 医学筛查 |

### 2.4 为什么医学影像用 Patch-Level？

医学影像中，**漏诊 (FN) 比误报 (FP) 严重得多**：
- 漏诊癌症 → 延误治疗，可能致命
- 误报 → 额外复查，但不会造成伤害

Patch-level 评估直接回答临床问题：
> "这张图有没有可疑区域需要医生关注？" (二分类)

而不是：
> "这个检测框画得准不准？" (框匹配)

### 2.5 Confidence 阈值选取逻辑

#### 2.5.1 阈值选择原则

根据 **Funneling Evaluation Logic** (参考 ImgAssist 3.0 Model Selection Framework v3.1)：

| 评估目的 | 推荐阈值 | 逻辑依据 |
|----------|----------|----------|
| **高敏感度筛查** | conf=0.001 | 最小化漏诊 (FN)，接受较高 FP |
| **平衡检测** | conf=0.25 | 标准目标检测，平衡 P/R |
| **高精度检测** | conf=0.50+ | 最小化 FP，接受较高 FN |

#### 2.5.2 本报告阈值选择

| 评估模式 | 阈值 | 选择理由 |
|----------|------|----------|
| **Box-Level (Val)** | 0.25 | 标准 YOLO 验证配置，评估定位精度 |
| **Patch-Level (Test)** | 0.001 | 临床筛查场景，**Hard on Delivery** 原则 |

#### 2.5.3 阈值与临床目标对齐

参考 PCCP 监管要求：

```
┌─────────────────────────────────────────────────────────────────┐
│                 阈值选择 → 临床目标对齐                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  conf=0.001 (Patch-Level)                                       │
│  ├── 目标: Sensitivity ≥ 98% (不漏诊)                          │
│  ├── 对应: PCCP Margin Recall ≥ 61% 的 Hard Gate               │
│  └── 原则: "Hard on Delivery" - 保证安全性底线                 │
│                                                                 │
│  conf=0.25 (Box-Level)                                          │
│  ├── 目标: 平衡 Precision/Recall                               │
│  ├── 对应: Signal 质量评估 (非 Pass/Fail Gate)                 │
│  └── 原则: "Weighted on Precision" - 优化定位精度               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.5.4 不同阈值下的预期行为

| 阈值 | Sensitivity | Specificity | FP 数量 | 适用场景 |
|------|-------------|-------------|---------|----------|
| 0.001 | **最高** (~98%+) | 最低 | 最多 | 初筛，不漏诊 |
| 0.1 | 高 | 低 | 多 | 敏感筛查 |
| 0.25 | 中等 | 中等 | 中等 | 标准检测 |
| 0.5 | 较低 | 较高 | 较少 | 高置信检测 |
| 0.75 | 低 | 高 | 少 | 确认诊断 |

### 2.6 公平对比框架

#### 2.6.1 对比原则

根据 **Signal vs Success** 原则：

```
Signal (L1 Box-Level) ≠ Success
Success = Delivery (Patch-Level) + Clinical Validation
```

**公平对比要求**：
1. **同一数据集**: 使用相同的 Test Set (17,785 patches)
2. **同一阈值**: Patch-Level 统一使用 conf=0.001
3. **同一评估代码**: 使用相同的指标计算逻辑
4. **同一预处理**: 对比时需考虑预处理差异的影响

#### 2.6.2 本报告对比配置

| 配置项 | YOLOv9 v12.1 | YOLO26s | 对比公平性 |
|--------|--------------|---------|------------|
| **Test 数据集** | 17,785 patches | 17,785 patches | 相同 |
| **Patch conf** | 0.001 | 0.001 | 相同 |
| **预处理** | Rectangle letterbox | Y-axis squash | **不同** (需注意) |
| **评估代码** | 统一 patch_metrics | 统一 patch_metrics | 相同 |

#### 2.6.3 对比局限性说明

本报告对比存在以下局限：

| 局限 | 影响 | 说明 |
|------|------|------|
| **预处理不同** | 中等 | YOLOv9 用 letterbox，YOLO26 用 squash |
| **训练配置不同** | 低 | 两者均使用 SGD，差异较小 |
| **Val-Test Gap** | 高 | YOLO26 存在 -38.6% gap，泛化性待验证 |

---

## 3. 性能对比

### 3.1 验证集 (Validation Set) - Box-Level

| 指标 | YOLOv9 v12.1 | YOLO26s | 差异 |
|------|--------------|---------|------|
| **mAP@0.5** | 76.6% | 67.6% | **-9.0%** |

### 3.2 测试集 (Test Set) - Box-Level

| 指标 | YOLOv9 v12.1 | YOLO26s | 差异 |
|------|--------------|---------|------|
| **mAP@0.5** | - | 29.0% | - |

**Val-Test Gap**:
- YOLO26s: **-38.6%** (67.6% → 29.0%)
- YOLOv9 v12.1: Gap 更小

### 3.3 测试集 - Patch-Level (conf=0.001)

| 指标 | YOLOv9 v12.1 | YOLO26s | 差异 |
|------|--------------|---------|------|
| **Total Patches** | 17,785 | 17,785 | - |
| **TP (真阳性)** | 4,318 | 4,347 | +29 |
| **FN (假阴性/漏诊)** | 81 | 52 | **-29** |
| **FP (假阳性)** | 13,275 | 12,270 | **-1,005** |
| **TN (真阴性)** | 111 | 1,116 | +1,005 |
| **Sensitivity** | 98.16% | **98.82%** | **+0.66%** |
| **Specificity** | 0.83% | **8.34%** | **+7.51%** |

---

## 4. 关键发现

### 4.1 Sensitivity (敏感性/召回率)

- **YOLO26 略优**: 98.82% vs 98.16%
- **漏诊减少**: FN 从 81 降至 52，减少 29 例
- **临床意义**: 在癌症检测中，更高的 Sensitivity 意味着更少的漏诊

### 4.2 Specificity (特异性)

- **YOLO26 显著提升**: 8.34% vs 0.83% (约 **10倍** 提升)
- **误报减少**: FP 从 13,275 降至 12,270，减少 1,005 例
- **临床意义**: 更高的 Specificity 意味着更少的误诊，减少不必要的复查

### 4.3 Val-Test Gap

- **YOLO26 问题**: 仍存在 -38.6% 的 Val-Test Gap
- **表现**: 验证集 67.6% → 测试集 29.0%
- **原因**: 可能存在过拟合或数据分布不匹配
- **YOLOv9 更稳定**: Val-Test Gap 更小，泛化能力更好

### 4.4 Box-level mAP

- **YOLOv9 更高**: 76.6% vs 67.6%
- **差距**: 9.0 个百分点
- **意义**: 在 bounding box 定位精度上，YOLOv9 表现更好

---

## 5. 会议决定要点

根据团队会议讨论，形成以下决定：

### 5.1 推理性能

- **YOLO26 推理更快**
- **结论**: 目前推理时间不是决定性因素，TensorRT + NVIDIA GPU 可提供足够加速

### 5.2 商业考量

- **Ultralytics 授权费用**: 约 $15,000/年 (企业版)
- **长期风险**: 如公司未来转向非 Ultralytics 模型，仍需为旧版本设备支付授权费
- **部署限制**: 设备更新为手动方式，无法 OTA 更新

### 5.3 工作重心转移

- **当前瓶颈**: 数据质量 (CAM generation)，而非模型本身
- **决定**: 暂缓 YOLO26 vs YOLOv9 模型决策
- **下一步**: 专注于 CAM 生成，获取高质量 "Golden Dataset"

---

## 6. 综合评估

### 6.1 YOLO26 优势

| 优势 | 说明 |
|------|------|
| **NMS-free** | 原生端到端，无需后处理 NMS |
| **INT8 友好** | 量化部署更简单 |
| **Sensitivity 略高** | 98.82% vs 98.16%，少漏诊 29 例 |
| **Specificity 更高** | 8.34% vs 0.83%，少误报 1,005 例 |
| **推理更快** | 模型结构更高效 |

### 6.2 YOLO26 劣势

| 劣势 | 说明 |
|------|------|
| **Val-Test Gap** | -38.6%，泛化能力待验证 |
| **Box mAP 较低** | 67.6% vs 76.6% |
| **需授权费** | Ultralytics 企业版 ~$15k/年 |
| **部署限制** | 手动设备更新，授权费持续 |

### 6.3 YOLOv9 优势

| 优势 | 说明 |
|------|------|
| **Box mAP 更高** | 76.6%，定位更准确 |
| **泛化更稳定** | Val-Test Gap 更小 |
| **MIT 授权可用** | 无长期授权费负担 |

### 6.4 YOLOv9 劣势

| 劣势 | 说明 |
|------|------|
| **Sensitivity 略低** | 98.16%，多漏诊 29 例 |
| **Specificity 低** | 0.83%，误报较多 |
| **需 NMS 后处理** | 额外推理开销 |

---

## 7. 结论与建议

### 7.1 当前推荐

**继续使用 YOLOv9 v12.1 作为主模型**

理由：
1. Box-level mAP 更高 (76.6%)
2. Val-Test 泛化更稳定
3. MIT 授权版本可用，无长期授权费

### 7.2 YOLO26 待解决问题

1. **Val-Test Gap**: 需解决 -38.6% 的性能差距
2. **商业授权**: 评估长期成本影响
3. **数据质量**: 优先改进 CAM 生成

### 7.3 后续计划

1. **短期**: 专注 CAM 生成和数据质量
2. **中期**: 获取 Golden Dataset 后重新评估模型
3. **长期**: 根据业务需求和授权成本做最终决策

---

## 附录：混淆矩阵

### YOLOv9 v12.1

```
                 Predicted
              Positive  Negative
Actual  Pos    4,318      81      (Total: 4,399)
        Neg   13,275     111      (Total: 13,386)

Sensitivity = 4318 / 4399 = 98.16%
Specificity = 111 / 13386 = 0.83%
```

### YOLO26s

```
                 Predicted
              Positive  Negative
Actual  Pos    4,347      52      (Total: 4,399)
        Neg   12,270   1,116      (Total: 13,386)

Sensitivity = 4347 / 4399 = 98.82%
Specificity = 1116 / 13386 = 8.34%
```

---

## 相关文档

- [会议决定.md](会议决定.md) - 会议讨论详情
- [EVALUATION.md](EVALUATION.md) - 详细评估方法
- [PREPROCESSING.md](PREPROCESSING.md) - 预处理方法对比
